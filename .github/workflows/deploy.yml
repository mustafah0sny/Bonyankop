name: Deploy to MonsterASP

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
        
    - name: Restore dependencies
      run: dotnet restore BonyankopAPI/BonyankopAPI.csproj
      
    - name: Build
      run: dotnet build BonyankopAPI/BonyankopAPI.csproj --configuration Release --no-restore
      
    - name: Publish
      run: dotnet publish BonyankopAPI/BonyankopAPI.csproj -c Release -o ./publish
      
    - name: Create production appsettings
      run: |
        $productionSettings = @"
        {
          "ConnectionStrings": {
            "DefaultConnection": "${{ secrets.PRODUCTION_CONNECTION_STRING }}"
          },
          "JwtSettings": {
            "SecretKey": "${{ secrets.JWT_SECRET_KEY }}",
            "Issuer": "BonyankopAPI",
            "Audience": "BonyankopAPIUsers",
            "ExpiryMinutes": 60
          },
          "DetailedErrors": false,
          "Logging": {
            "LogLevel": {
              "Default": "Information",
              "Microsoft.AspNetCore": "Warning",
              "Microsoft.EntityFrameworkCore": "Warning"
            }
          },
          "AllowedHosts": "*"
        }
        "@
        $productionSettings | Out-File -FilePath ./publish/appsettings.Production.json -Encoding UTF8
        
        # Also create appsettings.json as fallback
        $productionSettings | Out-File -FilePath ./publish/appsettings.json -Encoding UTF8
      shell: pwsh
      
    - name: Create deployment package
      run: Compress-Archive -Path ./publish/* -DestinationPath ./BonyankopAPI-Deploy.zip -Force
      
    - name: Install WinSCP
      run: |
        choco install winscp -y --no-progress
      shell: pwsh
      
    - name: Deploy via WinSCP (FTP)
      run: |
        $ftpServer = "${{ secrets.FTP_SERVER }}"
        $ftpUsername = "${{ secrets.FTP_USERNAME }}"
        $ftpPassword = "${{ secrets.FTP_PASSWORD }}"
        
        # Create WinSCP script
        $scriptContent = @"
        option batch abort
        option confirm off
        open ftp://${ftpUsername}:${ftpPassword}@${ftpServer}
        option transfer binary
        
        # Remove old files (except logs)
        rm *.dll
        rm *.exe
        rm *.json
        rm *.pdb
        rm *.xml
        
        # Upload new files
        put publish\* /
        
        # Upload subdirectories
        synchronize remote -delete publish /
        
        close
        exit
        "@
        
        $scriptContent | Out-File -FilePath deploy-script.txt -Encoding ASCII
        
        # Run WinSCP
        & "C:\Program Files (x86)\WinSCP\WinSCP.com" /script=deploy-script.txt /log=winscp.log
        
        if ($LASTEXITCODE -ne 0) {
          Get-Content winscp.log
          throw "Deployment failed with exit code $LASTEXITCODE"
        }
        
        Write-Host "Deployment completed successfully!"
      shell: pwsh
