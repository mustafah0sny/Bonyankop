name: Deploy to MonsterASP

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 6 (MonsterASP supported)
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'

    - name: Restore dependencies
      run: dotnet restore BonyankopAPI/BonyankopAPI.csproj

    - name: Build
      run: dotnet build BonyankopAPI/BonyankopAPI.csproj -c Release --no-restore

    - name: Publish (framework-dependent ONLY)
      run: dotnet publish BonyankopAPI/BonyankopAPI.csproj -c Release --self-contained false -o publish

    - name: Create production appsettings
      shell: pwsh
      run: |
        $productionSettings = @"
        {
          "ConnectionStrings": {
            "DefaultConnection": "${{ secrets.PRODUCTION_CONNECTION_STRING }}"
          },
          "JwtSettings": {
            "SecretKey": "${{ secrets.JWT_SECRET_KEY }}",
            "Issuer": "BonyankopAPI",
            "Audience": "BonyankopAPIUsers",
            "ExpiryMinutes": 60
          },
          "DetailedErrors": false,
          "Logging": {
            "LogLevel": {
              "Default": "Information",
              "Microsoft.AspNetCore": "Warning",
              "Microsoft.EntityFrameworkCore": "Warning"
            }
          },
          "AllowedHosts": "*"
        }
        "@

        $productionSettings | Out-File publish/appsettings.json -Encoding UTF8
        $productionSettings | Out-File publish/appsettings.Production.json -Encoding UTF8

    - name: Deploy to MonsterASP via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: publish/
        server-dir: wwwroot/
        dangerous-clean-slate: false
        exclude: |
          **/runtimes/**            # Exclude all 'runtimes/' folders and subdirectories
          **/*.pdb                 # Exclude all .pdb files (debugging symbols)
          **/logs/**                # Exclude all 'logs/' folders
          **/appsettings.Development.json  # Exclude development config file
