name: Deploy to MonsterASP

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
        
    - name: Restore dependencies
      run: dotnet restore BonyankopAPI/BonyankopAPI.csproj
      
    - name: Build
      run: dotnet build BonyankopAPI/BonyankopAPI.csproj --configuration Release --no-restore
      
    - name: Publish
      run: dotnet publish BonyankopAPI/BonyankopAPI.csproj -c Release -o ./publish
      
    - name: Create production appsettings
      run: |
        $productionSettings = @"
        {
          "ConnectionStrings": {
            "DefaultConnection": "${{ secrets.PRODUCTION_CONNECTION_STRING }}"
          },
          "JwtSettings": {
            "SecretKey": "${{ secrets.JWT_SECRET_KEY }}",
            "Issuer": "BonyankopAPI",
            "Audience": "BonyankopAPIUsers",
            "ExpiryMinutes": 60
          },
          "Serilog": {
            "MinimumLevel": {
              "Default": "Information",
              "Override": {
                "Microsoft": "Warning",
                "Microsoft.AspNetCore": "Warning",
                "Microsoft.EntityFrameworkCore": "Information",
                "System": "Warning"
              }
            },
            "WriteTo": [
              {
                "Name": "Console"
              },
              {
                "Name": "File",
                "Args": {
                  "path": "logs/bonyankop-.log",
                  "rollingInterval": "Day",
                  "retainedFileCountLimit": 30,
                  "shared": true
                }
              },
              {
                "Name": "File",
                "Args": {
                  "path": "logs/bonyankop-errors-.log",
                  "restrictedToMinimumLevel": "Error",
                  "rollingInterval": "Day",
                  "retainedFileCountLimit": 90,
                  "shared": true
                }
              }
            ]
          },
          "DetailedErrors": false,
          "Logging": {
            "LogLevel": {
              "Default": "Information",
              "Microsoft.AspNetCore": "Warning",
              "Microsoft.EntityFrameworkCore": "Warning"
            }
          },
          "AllowedHosts": "*"
        }
        "@
        $productionSettings | Out-File -FilePath ./publish/appsettings.Production.json -Encoding UTF8
        
        # Also create appsettings.json as fallback
        $productionSettings | Out-File -FilePath ./publish/appsettings.json -Encoding UTF8
      shell: pwsh
      
    - name: Create deployment package
      run: Compress-Archive -Path ./publish/* -DestinationPath ./BonyankopAPI-Deploy.zip -Force
      
    - name: Install WinSCP
      run: |
        choco install winscp -y --no-progress
      shell: pwsh
      
    - name: Create app_offline.htm
      run: |
        $offlineContent = @"
        <!DOCTYPE html>
        <html>
        <head>
            <title>Application Updating</title>
            <style>
                body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
                h1 { color: #333; }
            </style>
        </head>
        <body>
            <h1>Application is being updated</h1>
            <p>Please wait a moment and refresh the page...</p>
        </body>
        </html>
        "@
        $offlineContent | Out-File -FilePath ./publish/app_offline.htm -Encoding UTF8
      shell: pwsh
      
    - name: Deploy via WinSCP (FTP)
      run: |
        $ftpServer = "${{ secrets.FTP_SERVER }}"
        $ftpUsername = "${{ secrets.FTP_USERNAME }}"
        $ftpPassword = "${{ secrets.FTP_PASSWORD }}"
        
        # Create WinSCP script
        $scriptContent = @"
        option batch continue
        option confirm off
        open ftp://${ftpUsername}:${ftpPassword}@${ftpServer}
        option transfer binary
        
        # List current directory to see structure
        ls
        
        # Try to create wwwroot directory if it doesn't exist
        mkdir wwwroot
        
        # Change to wwwroot directory
        cd wwwroot
        
        # Upload app_offline.htm first to stop the application
        put publish\app_offline.htm
        
        # Upload all files (overwrite existing) - note the trailing slash
        put -delete publish\* ./
        
        # Remove app_offline.htm to restart the application
        rm app_offline.htm
        
        close
        exit
        "@
        
        $scriptContent | Out-File -FilePath deploy-script.txt -Encoding ASCII
        
        # Run WinSCP
        & "C:\Program Files (x86)\WinSCP\WinSCP.com" /script=deploy-script.txt /log=winscp.log
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Deployment completed with warnings. Checking log..."
          Get-Content winscp.log | Select-Object -Last 100
        } else {
          Write-Host "Deployment completed successfully!"
        }
        
        Write-Host "`n=== Deployment Log Summary ==="
        Get-Content winscp.log | Select-Object -Last 20
      shell: pwsh
